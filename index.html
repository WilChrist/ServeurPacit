<!DOCTYPE html>
<html lang="fr" ng-app="myApp" >
<head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <link  href="https://github.com/angular-ui/bootstrap/blob/master/src/pagination/pagination.js">
<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-route.js"></script>

<link rel="stylesheet" type="text/css" href="css/layout.css">
<link rel="stylesheet" type="text/css" href="css/layout2.css">
<meta charset="utf-8" />

    <!-- les liens de Dashboard-->
            <link rel="icon" type="image/png" href="assets/img/favicon.ico">

            <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
            <meta name="viewport" content="width=device-width" />


            <!-- Animation library for notifications   -->
            <link href="assets/css/animate.min.css" rel="stylesheet"/>

            <!--  Light Bootstrap Table core CSS    -->
            <link href="assets/css/light-bootstrap-dashboard.css?v=1.4.0" rel="stylesheet"/>


            <!--  CSS for Demo Purpose, don't include it in your project     -->
            <link href="assets/css/demo.css" rel="stylesheet" />


            <!--     Fonts and icons     -->
            <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
            <link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300' rel='stylesheet' type='text/css'>
            <link href="assets/css/pe-icon-7-stroke.css" rel="stylesheet" />

            <!--   Core JS Files   -->
            <script src="assets/js/jquery.3.2.1.min.js" type="text/javascript"></script>
            <script src="assets/js/bootstrap.min.js" type="text/javascript"></script>

            

            <!--  Notifications Plugin    -->
            <script src="assets/js/bootstrap-notify.js"></script>


            <!-- Light Bootstrap Table Core javascript and methods for Demo purpose -->
            <script src="assets/js/light-bootstrap-dashboard.js?v=1.4.0"></script>

            <!-- Light Bootstrap Table DEMO methods, don't include it in your project! -->
            <script src="assets/js/demo.js"></script>
 
  <!-- Angular Material requires Angular.js Libraries -->
 
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-animate.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-aria.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-messages.min.js"></script>

  <!-- Angular Material Library -->
  <script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.8/angular-material.min.js"></script>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.8/angular-material.min.css">
  
  
<!-- tous les liens pour le Gantt-->

 <!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script> -->
  <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

  <script src="gantt/libs/jquery/jquery.livequery.1.1.1.min.js"></script>
  <script src="gantt/libs/jquery/jquery.timers.js"></script>

  <script src="gantt/libs/utilities.js"></script>
  <script src="gantt/libs/forms.js"></script>
  <script src="gantt/libs/date.js"></script>
  <script src="gantt/libs/dialogs.js"></script>
  <script src="gantt/libs/layout.js"></script>
  <script src="gantt/libs/i18nJs.js"></script>
  <script src="gantt/libs/jquery/dateField/jquery.dateField.js"></script>
  <script src="gantt/libs/jquery/JST/jquery.JST.js"></script>

  <script type="text/javascript" src="gantt/libs/jquery/svg/jquery.svg.min.js"></script>
  <script type="text/javascript" src="gantt/libs/jquery/svg/jquery.svgdom.1.8.js"></script>


  <script src="gantt/ganttUtilities.js"></script>
  <script src="gantt/ganttTask.js"></script>
  <script src="gantt/ganttDrawerSVG.js"></script>
  <script src="gantt/ganttZoom.js"></script>
  <script src="gantt/ganttGridEditor.js"></script>
  <script src="gantt/ganttMaster.js"></script> 

  <link rel=stylesheet href="gantt/platform.css" type="text/css">
  <link rel=stylesheet href="gantt/libs/jquery/dateField/jquery.dateField.css" type="text/css">

  <link rel=stylesheet href="gantt/gantt.css" type="text/css">
  <link rel=stylesheet href="gantt/ganttPrint.css" type="text/css" media="print">
<!-- fin des liens pour le gantt-->

<!-- lien pour le chart -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <script>
            // Get the modal
               /* $('#id01').on('click', function(e) {
                    // Lorsque le formulaire est affiché, il s'estompe à la condition
                    // d'avoir un click à droite ou à gauche du formulaire. On fixe alors
                    // une position minimum et un maximum horizontale
                    var minwidth = ($(window).width() - $('#id01 form').width())/2;
                    var maxwidth = minwidth + $('#id01 form').width();
                    var minheight = ($(window).height() - $('#id01 form').height())/2;
                    var maxheight = minheight + $('#id01 form').height();
                    
                    if (e.pageX < minwidth || e.pageX > maxwidth || e.pageY<minheight || e.pageY>maxheight)
                        $('#id01').fadeOut(200);
                });
                $('#id02').on('click', function(e) {
                    // Lorsque le formulaire est affiché, il s'estompe à la condition
                    // d'avoir un click à droite ou à gauche du formulaire. On fixe alors
                    // une position minimum et un maximum horizontale
                    var minwidth = ($(window).width() - $('#id02 form').width())/2;
                    var maxwidth = minwidth + $('#id02 form').width();
                    var minheight = ($(window).height() - $('#id02 form').height())/2;
                    var maxheight = minheight + $('#id02 form').height();
                    
                    if (e.pageX < minwidth || e.pageX > maxwidth || e.pageY<minheight || e.pageY>maxheight)
                        $('#id02').fadeOut(200);
                });*/
            
    </script>
    
    <script>
        var k={};
        //module principale de l'application
        var app = angular.module('myApp', ['ngRoute','ngMaterial','ngMessages']);
        app.service('shared',function(){
                var item={};
                this.getitem=function(){
                    return item;
                }
                this.setitem=function(value){
                    item=value;
                }
            });

                app.controller('MyCtrl', ['$scope', '$filter','$mdDialog','shared','session','$http', function ($scope, $filter,$mdDialog,shared,session,$http) {
                    $scope.currentPage = 0;
                    $scope.pageSize = 10;
                    $scope.data = [];
                    $scope.q = '';
                    
                    $scope.check = function(){
                        session.islogged();
                        this.getprojectlist();
                    }
                    
                    $scope.getData = function () {
                        var arr = [];
                        if($scope.q == '') {
                            arr = $scope.data;
                        } else {
                            for(var ea in $scope.data) {
                                if($scope.data[ea].indexOf($scope.q) > -1) {
                                    arr.push( $scope.data[ea] );
                                }
                            }
                        }
                        return arr;
                   
                    }
                    
                    $scope.getprojectlist = function(){
                        $http.post("/api/projectslist") /*j'ai retirer le type*/
                            .then (function success(data, status, headers, config) {
                                if(data.data.list != null){
                                    $scope.data = data.data.list;
                                }
                                else{
                                    alert("Euh il n'y a pas de projets enregistrés");
                                }
                            },function eroor(data, status, headers, config) {
                            alert( "failure message: " + JSON.stringify({data: data}));
                        });
                    }

                    $scope.myFunc = function(ev,item) {
                        shared.setitem(item);
                        $scope.status = '  ';
                        $scope.customFullscreen = false;
                        $mdDialog.show({
                            controller: DialogController,
                            templateUrl: 'dialog1.tmpl.html',
                            parent: angular.element(document.body),
                            targetEvent: ev,
                            clickOutsideToClose:true,
                            fullscreen: $scope.customFullscreen // Only for -xs, -sm breakpoints.
                            })
                            .then(function(answer) {
                            $scope.status = 'You said the information was "' + answer + '".';
                            }, function() {
                            $scope.status = 'You cancelled the dialog.';
                        });
                    }
                    function DialogController($scope, $mdDialog,shared) {
                            $scope.currentprojet=shared.getitem();
                            $scope.hide = function() {
                            $mdDialog.hide();
                            };

                            $scope.cancel = function() {
                            $mdDialog.cancel();
                            };

                            $scope.answer = function(answer) {
                            $mdDialog.hide(answer);
                            };
                        }
                
                    
                    $scope.numberOfPages=function(){
                        return Math.ceil($scope.getData().length/$scope.pageSize);                
                    }
                    
                    /*for (var i=0; i<65; i++) {
                        $scope.data.push("Item "+i);
                    }*/
                }]);

                //We already have a limitTo filter built-in to angular,
                //let's make a startFrom filter
                app.filter('startFrom', function() {
                    return function(input, start) {
                        start = +start; //parse to int
                        return input.slice(start);
                    }
            });
            
            
            
            //service de gestion de la session
            app.service('session', function($rootScope,$http) {
                
                //fonction pour connecter les utilisateur
                this.connect=function(emaillogin,pswlogin,typelogin){
                    $http.post("/api/login",{email:emaillogin,password:pswlogin}) /*j'ai retirer le type*/
                    .then (function success(data, status, headers, config) {
                        if(data.data.user != null){
                            $rootScope.user=data.data.user;
                            window.location="#!listeprojets"; 
                        }
                        else{
                            alert("Email ou mot de passe invalide");
                            window.location="#!/";
                        }
                    },function eroor(data, status, headers, config) {
                    alert( "failure message: " + JSON.stringify({data: data}));
                     });
                }

                //fonction pour l'inscription
                this.register=function(uname,emailsignup,pswsignup,sexe){
                   
                    $http.post("/api/serviceProviders",{username:uname,email:emailsignup,password:pswsignup,gender:sexe})
                    .then(function success(data){
                        alert("Vous avez bien été inscrit");
                        window.location="#!/";
                    },function eroor(data, status, headers, config) {
                    alert( "failure message: " + JSON.stringify({data: data}));
                     });
                }

                this.test = function(){
                    $http.get("/api/serviceProviders")
                    .then(function success(data){
                        //console.log(data);
                    },function error(data,status){
                        //console.log(data);
                    })
                }
                //vérifie si l'utilisateur est bien co snnecté
                this.islogged = function () {
                    $http.post("/api/issession")
                    .then(function success(data){
                        if(data.data.session){
                            $rootScope.user=data.data.user;
                        }
                        else{
                            window.location="#!/";
                        }
                    })
                }
                
                //fonction pour déconnecter les utilisateur
                this.deconnect=function(){
                    $http.post("/api/deconnect")
                    .then(function success(data){
                        window.location="#!/";
                     })
                }
            });
            /*controller de connexion*/
            app.controller("CtrlConnection", function($scope,session) {
                $scope.login = function() {
                    session.connect($scope.emaillogin,$scope.pswlogin,$scope.typelogin);   
                }
            });
            //Controlle de deconnexion
            app.controller("CtrlDeconnection", function($scope,session) {
                $scope.deconnect = function() {
                    session.deconnect();   
                }
            });

            /*controller pour l'inscription*/
            app.controller("Ctrlinscription",function($scope,session){
                $scope.error="";
                $scope.inscrire = function(){
                    session.register($scope.uname,$scope.emailsignup,$scope.pswsignup,$scope.sexe);
                    //session.test();
                }

                $scope.checkpassword=function(){
                    if($scope.pswsignup != $scope.pswsignup2) $scope.error="password doesn't match";
                }
                
                $scope.clearerror = function(){
                    $scope.error="";
                }
            });
            app.controller("Ctrlevaluation",function($scope,session,$http,$routeParams,$rootScope){
                $scope.gantttoevaluate={};
                $scope.tasks=[];
                $scope.idprojet = $routeParams.id;
               // alert($routeParams.id);
                $scope.getprojcet=function(){
                    session.islogged();
                    $http.get("/api/diagrams/"+$routeParams.id)
                    .then (function success(data, status, headers, config) {
                        //console.log(data.data);
                        $scope.gantttoevaluate = data.data.gantt;
                        $scope.tasks = $scope.gantttoevaluate.objet.tasks.slice(1,$scope.gantttoevaluate.objet.tasks.length); 
                    },function eroor(data, status, headers, config) {
                    alert( "failure message: " + JSON.stringify({data: data}));
                     });
                }
                
                $scope.save_evaluation=function(){
                    var projetevaluation = {};
                    projetevaluation.id_project = $scope.idprojet;
                    projetevaluation.id_diagram = $scope.gantttoevaluate._id;
                    projetevaluation.id_user = $rootScope.user._id;
                    
                    var sum=0;
                    for(var i=1;i<$scope.gantttoevaluate.objet.tasks.length;i++){
                        var id="#"+$scope.gantttoevaluate.objet.tasks[i].id;
                        $scope.gantttoevaluate.objet.tasks[i].progress= parseInt( $(id).val());
                        sum+=parseInt($(id).val());
                    }

                    $scope.gantttoevaluate.objet.tasks[0].progress = sum/($scope.gantttoevaluate.objet.tasks.length-1);
                    projetevaluation.objet = $scope.gantttoevaluate.objet;
                    projetevaluation.global_evaluation = $scope.gantttoevaluate.objet.tasks[0].progress;
                    ///////////////////////////////////////envoie au serveur

                    $http.post("/api/evaluations/",{evaluation:projetevaluation}) /*j'ai retirer le type*/
                            .then (function success(data, status, headers, config) {
                                alert("evaluation done");
                                window.location="#!listeprojets";
                            },function eroor(data, status, headers, config) {
                            alert( "failure message: " + JSON.stringify({data: data}));
                        });
                }

            });

            /*controller du dashboard*/
            app.controller("dashCtrl",function($scope,session){
                $scope.check=function(){
                    session.islogged(); 
                }
                $scope.logout=function(){
                    session.deconnect();
                }
                $scope
            });

            app.controller("formCtrl",function($scope,$rootScope,$http){
                var currentTab = 0;
                $scope.initialisation=function(){
                    this.showTab(currentTab);
                }

                $scope.save=function(){
                    var projettosave={name:$scope.nomproj,location:$scope.lieuproj,description:$scope.descriptionproj,author:$rootScope.user._id,};
                    var gantttosave = {name:$scope.nomproj+"_Gantt",objet:ge.saveGantt()}
                    projettosave.end_date = gantttosave.objet.tasks[0].start;
                    projettosave.begin_date = gantttosave.objet.tasks[0].end;

                    $http.post("/api/diagrams",{gantt:gantttosave})
                    .then (function success(data, status, headers, config) {
                       
                        if(data.data.ganttsaved){
                            //alert("gatt sauvegarder"); 
                            projettosave.id_diagram = data.data.ganttsaved._id;
                            ////////////////////////////////////////////////////////////////////////////////////////
                                    $http.post("/api/projects",{projet:projettosave})
                                        .then (function success(data, status, headers, config) {
                                        
                                            if(data.data.success){
                                                //alert("project sauvegarder");     
                                            }
                                            else{
                                                alert("une erreur est survenue lors de la sauvegarde du projet");
                                            }
                                        },function eroor(data, status, headers, config) {
                                        alert( "failure message: " + JSON.stringify({data: data}));
                                     });
                            ///////////////////////////////////////////////////////////////////////////////////////
                        }
                        else{
                            alert("une erreur est lors de la sauvegarde du diagramme");
                        }
                    },function eroor(data, status, headers, config) {
                    alert( "failure message: " + JSON.stringify({data: data}));
                     });
                }
                $scope.fixStepIndicator=function(n){
                    // This function removes the "active" class of all steps...
                    var i, x = document.getElementsByClassName("step");
                    for (i = 0; i < x.length; i++) {
                        x[i].className = x[i].className.replace(" active", "");
                    }
                    //... and adds the "active" class on the current step:
                    x[n].className += " active";
                }

                $scope.showTab = function(n){
                    // This function will display the specified tab of the form...
                    var x = document.getElementsByClassName("tab");
                    x[n].style.display = "block";
                    //... and fix the Previous/Next buttons:
                    if (n == 0) {
                        document.getElementById("prevBtn").style.display = "none";
                    } else {
                        document.getElementById("prevBtn").style.display = "inline";
                    }
                    if (n == (x.length - 1)) {
                        document.getElementById("nextBtn").innerHTML = "Submit";
                    } else {
                        document.getElementById("nextBtn").innerHTML = "Next";
                    }
                    //... and run a function that will display the correct step indicator:
                    this.fixStepIndicator(n);
                    $('#mainContent').hide().show(0);
                }

                $scope.nextPrev = function(n){
                    // This function will figure out which tab to display
                    var x = document.getElementsByClassName("tab");
                    // Exit the function if any field in the current tab is invalid:
                    if (currentTab == 0 && !this.validateForm()) return false;
                    // Hide the current tab:
                    x[currentTab].style.display = "none";
                    // Increase or decrease the current tab by 1:
                    currentTab = currentTab + n;
                    // if you have reached the end of the form...
                    if (currentTab >= x.length) {
                        // ... the form gets submitted:
                        this.save();
                        this.clearfrom();
                        currentTab=0;this.showTab(0);
                        return false;
                    }
                    // Otherwise, display the correct tab:
                    this.showTab(currentTab);
                    //ge.splitter.resize(50);
                    //$("#50-split").click();
                    document.getElementById("50-split").click();
                    document.getElementById("edit-fictif").click();
                    document.getElementById("close-fictif").click();
                }

                $scope.validateForm = function(){
                    var x, y,z, i, valid = true;
                    x = document.getElementsByClassName("tab");
                    y = x[currentTab].getElementsByTagName("input");
                    z = x[currentTab].getElementsByTagName("textarea");
                    // A loop that checks every input field in the current tab:
                    for (i = 0; i < y.length; i++) {
                        // If a field is empty...
                        if (y[i].value == "") {
                        // add an "invalid" class to the field:
                        y[i].className += " invalid";
                        // and set the current valid status to false
                        valid = false;
                        }
                    }
                    if(z[0].value == ""){
                        z[0].className += " invalid"
                        valid=false;
                    }
                    // If the valid status is true, mark the step as finished and valid:
                    if (valid) {
                        document.getElementsByClassName("step")[currentTab].className += " finish";
                    }
                    return valid; // return the valid status
                    }
                
                $scope.clearfrom = function(){
                        $scope.nomproj="";
                        $scope.lieuproj="";
                        $scope.descriptionproj="";
                        ge.reset();
                }

                    function fixStepIndicator(n) {
                    // This function removes the "active" class of all steps...
                    var i, x = document.getElementsByClassName("step");
                    for (i = 0; i < x.length; i++) {
                        x[i].className = x[i].className.replace(" active", "");
                    }
                    //... and adds the "active" class on the current step:
                    x[n].className += " active";
                }
            })
            
            /*controller de la page de recapitulatif*/
            app.controller("recapCtrl",function($scope,session,$rootScope,$routeParams,$http,$q,$timeout){
                //var evaluation =null;
                $rootScope.categorie = [0,0,0,0];
                
                $scope.check=function(){

                session.islogged(); 
/************************************************************************************************/                    
                let promise= $http.post("/api/evaluationsp/"+$routeParams.id);

                $q.all([promise]).then(data=>{
                    $rootScope.evaluationp=data[0].data.projectevaluations;
                    //console.log($rootScope.evaluationp);
                    //this.trier();
                    $timeout(this.trier(),0);
                    bindchart($rootScope.categorie);
                })

                    //console.log($scope.evaluationp);
                    
                    
                    
                }

                $scope.getdata=function(evaluationpc){
                    
                }

                $scope.trier = function(){
                   // console.log($rootScope.evaluationp);
                    for(var i=0;i<$rootScope.evaluationp.tab.length;i++){
                        if($rootScope.evaluationp.tab[i]<26){
                           $rootScope.categorie[0]++; 
                        } else
                        if($rootScope.evaluationp.tab[i]>=26 && $rootScope.evaluationp.tab[i]<51){
                          $rootScope.categorie[1]++;  
                        } else
                        if($rootScope.evaluationp.tab[i]>=51 && $rootScope.evaluationp.tab[i]<76){
                            $rootScope.categorie[2]++;
                        } else
                        if($rootScope.evaluationp.tab[i]>=76 && $rootScope.evaluationp.tab[i]<=100){
                            $rootScope.categorie[3]++;
                        } else{}
                    }
                }
              
            });

            app.config(function($routeProvider) {
                $routeProvider
                .when("/", {
                    templateUrl : "main.html"
                })
                .when("/dashboard", {
                    templateUrl :"dashboard.html"
                })
                .when("/evaluation/:id",{
                    templateUrl :"evaluation.html"
                    ,controller:'Ctrlevaluation'
                })
                .when("/profil", {
                    templateUrl :"profil.html"
                })
                .when("/listeprojets", {
                    templateUrl :"liste_projets.html"
                })
                .when("/recapitulatifprojet/:id",{
                    templateUrl:'projectrecap.html',
                    controller:'recapCtrl'
                })
                .when("/erreur",{
                    templateUrl:"erreur.html"
                })
                .otherwise({redirectTo : '/erreur' });
            });
            function trions(tab){
                //console.log(tab);
            }
            </script>
    <title>Bienvenue sur PARCIT (Participation Citoyenne)</title>
</head>
<body ng-view >
       

</body>
</html>
